# GeoWatch Contrib App

GeoWatch is a spatially-enabled distributed message broker for streaming data.  Geowatch is a contrib app starting with GeoNode 2.4.  The previous `slack` contrib app features are all included in the new `geowatch` contrib app.  The `slack` contrib app is no longer included.

## Settings

### Activation

To activate the geowatch contrib app, you need to add `geonode.contrib.geowatch` to `INSTALLED_APPS` and set the `GEOWATCH_ENABLED` flag to `True`.  For example, with:

```Python
GEONODE_CONTRIB_APPS = (
    'geonode.contrib.geowatch'
)
GEONODE_APPS = GEONODE_APPS + GEONODE_CONTRIB_APPS
...
# Settings for GeoWatch contrib app
GEOWATCH_ENABLED=True
```

### Configuration

The relevant section in [settings.py](https://github.com/GeoNode/geonode/blob/master/geonode/settings.py) starts at line [812](https://github.com/GeoNode/geonode/blob/master/geonode/settings.py#L812).

```Python
# Settings for GeoWatch contrib app
GEOWATCH_ENABLED = False
```

Other than that, most configuration should occur in the local_settings.py

Use `GEOWATCH_CONFIG` to set "global" variables, so you don't need to set it everytime for each broker.

```Python
GEOWATCH_CONFIG = {
    "aws_region": "us-west-1",
    "aws_access_key_id": "XXX",
    "aws_secret_access_key": "XXX"
}
```

Use `GeoWATCH_BROKERS_CRON` to describe the "cron job" brokers that are run by geowatch-brokers.py.  A common use case is to read geojson from a AWS Kinesis stream and write to a layer.  However, you can use any built-in GeoWatch functionality here (repeat messages, aggregate messages, send alerts, etc.).  In enterprise-deployments, this would likely be an empty list and you'd run these processes on other servers instead.

```Python
GEOWATCH_BROKERS_CRON = [
    {
        "enabled": True,
        "name": "incoming geojson",
        "description": "This broker receives incoming geojson from an AWS kinesis stream and writes to GeoNode layers using WFS-T.",
        "consumers":
        [
            {
                "enabled": True,
                "backend": "kinesis",
                "codec": "json",
                "topic_prefix": "",
                "topic": "geowatch-geonode-data",
                "shard_it_type": "TRIM_HORIZON"
            }
        ],
        "stores_out":
        [
            {
                "enabled": True,
                "backend": "wfs",
                "key": None,
                "codec": "wfs",
                "options": {
                    "url": "http://localhost:8080/geoserver/wfs",
                    "auth_user": "admin",
                    "auth_password": "admin"
                }
            }
        ]
    }
]
```

Use `GEOWATCH_BROKERS_EVENT` to describe the broker that handles internal events generated by GeoNode.  Currently, the geowatch contrib app will generate events for metadata changes to resources (documents, layers, and maps), user logins, and creating new groups.  Coverage will be expanded as GeoWatch is more seamlessly integrated into the notifications system.

```Python
GEOWATCH_BROKERS_EVENT = [
    {
        "enabled": True,
        "name": "GeoNode Events",
        "description": "General broker for internal GeoNode-based events.",
        "filter_metadata": {
            "actiontype": ['new', 'edit', 'remove'],
            "targettype": ["document", "layer", "map", "user", "group"]
        },
        "producers":
        [
            {
                "enabled": True,
                "backend": "slack",
                "codec": "slack",
                "topics": ["general"],
                "templates": "SLACK_MESSAGE_TEMPLATES",
                "url_webhook": "https://hooks.slack.com/services/TXXX/BXXX/XXX"
            },
            {
                "enabled": True,
                "backend": "kinesis",
                "codec": "json",
                "topic_prefix": "",
                "topics": ["geowatch-geonode"],
                "topic_check": True
            },
            {
                "enabled": False,
                "backend": "sns",
                "codec": "plain",
                "topics": ["arn:aws:sns:us-west-1:XXXXX:XXXXX"],
                "templates": "SNS_MESSAGE_TEMPLATES"
            },
            {
                "enabled": False,
                "backend": "email",
                "codec": "plain",
                "topics": ["geonodev@example.com"],
                "templates": "HTML_MESSAGE_TEMPLATES",
                "options": {"use_django": True}
            }
        ],
        "stores_out": []
    }
]
```

Use `GEOWATCH_BROKER_METADATA` to configure a metadata "bot" that is run by `geonode-broker-metadata.py`.  This broker will scan metadata changes.  If it detects that key fields have not been filled in, it will send a nice email to the layer owner, asking them to update the fields at their convience.  Additional work is needed on configuring the email language/frequency/etc, but this can automate some of the communication required to convince users to maintain good metadata.

```Python
GEOWATCH_BROKER_METADATA = {
    "enabled": True,
    "name": "Metadata Bot",
    "description": "This broker checks new layers for missing metdata and sends notifications",
    "consumers":
    [
        {
            "enabled": True,
            "backend": "kinesis",
            "codec": "json",
            "topic_prefix": "",
            "topic": "geowatch-geonode",
            "topic_check": True,
            "shard_it_type": "TRIM_HORIZON"
        }
    ]
}
```

### Special Note: Why Slack?

Slack + GeoNode can dramatically decrease many of the paint points of data management.  Slack is a business productivity platform that replaces the need for email.  It's similar to a chatroom, but more sophisticated.  It provides a variety out of the box integrations as well as the ability to make custom integrations.  This provides new automated ways of synchronizing workflows across multiple platforms.  For instance, tracking GitHub commits, Tweets, and GeoNode posts all in one channel.

#### Incoming Webhooks
[Incoming webhooks](https://api.slack.com/incoming-webhooks) are Slack's way of exposing an endpoint you can push messages through, like an email address.  You can learn more at https://api.slack.com/incoming-webhooks.  GeoNode posts a JSON payload to these urls.  Slack converts these JSON payloads into messages.  Generally speaking, it's one url per channel (you can override this though).

#### Attachments
GeoNode uses Slack's [Attachments](https://api.slack.com/docs/attachments) API to build rich messages that include layer thumbnails and links to download shapefiles, view in Google Earth, etc.
